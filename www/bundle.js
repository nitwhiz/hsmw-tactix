var PerformanceCounter={deltaSum:0,deltaCount:100,deltas:[],renderFPS:!0,renderGraph:!1,renderDebug:!1,currentColor:"rgba(127, 0, 255, .75)",debug:[],graphX:80,tick:function(a){PerformanceCounter.deltas.unshift({delta:a,color:PerformanceCounter.currentColor});PerformanceCounter.deltas.length>PerformanceCounter.deltaCount&&PerformanceCounter.deltas.pop();PerformanceCounter.currentColor="rgba(127, 0, 255, .75)"},render:function(a){for(var c=PerformanceCounter.deltaSum=0;c<PerformanceCounter.deltaCount;++c)void 0!==
PerformanceCounter.deltas[c]&&(PerformanceCounter.deltaSum+=PerformanceCounter.deltas[c].delta,PerformanceCounter.renderGraph&&(a.fillStyle=PerformanceCounter.deltas[c].color,a.fillRect(c+PerformanceCounter.graphX,160-(PerformanceCounter.deltas[c].delta||0),1,PerformanceCounter.deltas[c].delta||0),a.fillStyle="rgba(0, 255, 127, .75)",a.fillRect(c+PerformanceCounter.graphX,144,1,1),a.fillStyle="rgba(255, 127, 0, .75)",a.fillRect(c+PerformanceCounter.graphX,120,1,1),Font.White.renderString(a,"60",PerformanceCounter.graphX,
138),Font.White.renderString(a,"25",PerformanceCounter.graphX,114)));PerformanceCounter.renderFPS&&Font.White.renderString(a,Math.round(1E3/(PerformanceCounter.deltaSum/PerformanceCounter.deltaCount)),2,2);if(PerformanceCounter.renderDebug)for(var c=0,b=PerformanceCounter.debug.length;c<b;++c)Font.White.renderString(a,PerformanceCounter.debug[c]+"",2,14+12*c)}},Cursor={cursors:{},current:"",add:function(a,c){Cursor.cursors[a]=c},set:function(a,c){c.style.cursor="url('"+Cursor.cursors[a]+"'), auto";
Cursor.current=a}},Utils={uid:1E3,sin_cos_45:1/Math.sqrt(2),getAngle:function(a,c,b,d){a-=b;c=Math.atan((c-d)/a);0>a&&(c+=Math.PI);return c},getAngleDegrees:function(a,c,b,d){a=Math.floor(180*Math.atan2(c-d,a-b)/Math.PI);0>a&&(a+=360);360<a&&(a-=360);return a},getDistance:function(a,c,b,d){return Math.sqrt(Math.pow(a-b,2)+Math.pow(c-d,2))},getDistance2:function(a,c,b,d){return(a-b)*(a-b)+(c-d)*(c-d)},merge:function(a,c){for(var b=[],d=0,e=a.length;d<e;++d)b.push(a[d]);d=0;for(e=c.length;d<e;++d)b.push(c[d]);
return b},extend:function(a,c){if("undefined"===typeof c)return a;var b={},d;for(d in a)a.hasOwnProperty(d)&&(b[d]=void 0!==c[d]?c[d]:a[d]);return b},roundPt5:function(a){return Math.floor(a)+.5},toDegrees:function(a){a=180*a/Math.PI;0>a&&(a+=360);return a},toRadians:function(a){return a*Math.PI/180},getUID:function(){return++Utils.uid}},Color={RGBToCMYK:function(a,c,b){if(0===a&&0===c&&0===b)return{C:0,M:0,Y:0,K:1};a/=255;c/=255;b/=255;var d=1-Math.max(a,c,b);return{C:(1-a-d)/(1-d),M:(1-c-d)/(1-
d),Y:(1-b-d)/(1-d),K:d}},CMYKToRGB:function(a,c,b,d){return{R:Math.floor(255*(1-a)*(1-d)),G:Math.floor(255*(1-c)*(1-d)),B:Math.floor(255*(1-b)*(1-d))}}},ColorChannel={CYAN:{C:1,M:0,Y:0,K:0},BLUE:{C:1,M:1,Y:0,K:0},MAGENTA:{C:0,M:1,Y:0,K:0},RED:{C:0,M:1,Y:1,K:0},YELLOW:{C:0,M:0,Y:1,K:0},GREEN:{C:1,M:0,Y:1,K:0}},ColorCorrection=function(a,c){this.channel=a;this.correction=c;this.channelDistance=function(b){return((0<this.channel.C?b.C/this.channel.C:0)+(0<this.channel.M?b.M/this.channel.M:0)+(0<this.channel.Y?
b.Y/this.channel.Y:0)+(0<this.channel.K?b.K/this.channel.K:0))/4};this.apply=function(b,a,c){b=Color.RGBToCMYK(b,a,c);a=this.channelDistance(b);b.C+=a*this.correction.C;b.M+=a*this.correction.M;b.Y+=a*this.correction.Y;b.K+=a*this.correction.K;b.C=Math.min(1,Math.max(0,b.C));b.M=Math.min(1,Math.max(0,b.M));b.Y=Math.min(1,Math.max(0,b.Y));b.K=Math.min(1,Math.max(0,b.K));b=Color.CMYKToRGB(b.C,b.M,b.Y,b.K);return{R:b.R,G:b.G,B:b.B}}},Art=function(a,c){var b=document.createElement("canvas"),d=b.getContext("2d"),
e=new Image;e.addEventListener("load",function(){++Art.loadedArts;b.width=e.width;b.height=e.height;d.drawImage(e,0,0);if(c instanceof Array&&0<c.length){for(var a=d.getImageData(0,0,b.width,b.height),l,k,n,h=0,m=a.data.length;h<m;h+=4){l=a.data[h];k=a.data[h+1];n=a.data[h+2];for(var q=0,p=c.length;q<p;++q)c[q]instanceof ColorCorrection&&(n=c[q].apply(l,k,n),l=n.R,k=n.G,n=n.B);a.data[h]=l;a.data[h+1]=k;a.data[h+2]=n}d.putImageData(a,0,0)}});e.src=a;++Art.availableArts;this.setRotation=function(a){d.clearRect(0,
0,b.width,b.height);d.translate(b.width/2,b.height/2);d.rotate(Utils.toRadians(a));d.translate(-b.width/2,-b.height/2);d.drawImage(e,0,0)};this.render=function(a,c,d){a.drawImage(b,c,d)}};Art.availableArts=0;Art.loadedArts=0;Art.isReady=function(){return Art.loadedArts===Art.availableArts};
var Animation=function(a,c,b){var d=[],e=0,f=0;this.duration=0;a.forEach(function(a){void 0!==a.path&&void 0!==a.duration&&(d.push({art:new Art(a.path,c||null),duration:a.duration}),this.duration+=a.duration)}.bind(this));this.getCurrentArt=function(){return d[e]};this.tick=function(a){f-=a;0>=f&&(++e,e>=d.length&&(!0===b?--e:e=0),f=d[e].duration)};this.render=function(a,b,c){d[e].art.render(a,b,c)};this.reset=function(){e=0;f=d[0].duration};this.instance=function(d){return new Animation(a,d||c,b)}},
Font=function(a,c,b,d){this.fontSize=d||12;this.lineHeight=14;this.letterSpacing=0;this.canvas=document.createElement("canvas");this.canvas.width=c;this.canvas.height=b;var e=this.canvas.getContext("2d"),f=new Image,l={};f.onload=function(){e.drawImage(f,0,0);for(var a,b,c,d=32,q,p;128>d;++d){a=this.fontSize*((d-d%32)/32-1);b=d%32*this.fontSize;c=e.getImageData(a,b,this.fontSize,1);for(var g=p=q=0,u=c.data.length;g<u;g+=4)if(0<q&&++q,-16711681===(c.data[g]<<24|c.data[g+1]<<16|c.data[g+2]<<8|c.data[g+
3]))if(c.data[g]=0,c.data[g+1]=0,c.data[g+2]=0,c.data[g+3]=0,e.putImageData(c,a,b),0===q)++q,p=g/4;else break;l[d]={width:q,start:p}}}.bind(this);f.src=a;this.getWidth=function(a){for(var b=0,c=0,d=a.length;c<d;++c)b+=l[a.charCodeAt(c)].width;return b};this.renderString=function(a,b,c,d){b=""+b;for(var e=c,f,g,k,m,r=0,x=b.length;r<x;++r)g=b.charCodeAt(r),10===g?(d+=this.lineHeight,c=e):(32>g&&(g=42),l[g]&&(k=l[g].width,m=l[g].start,f=this.fontSize*((g-g%32)/32-1),g=g%32*this.fontSize,a.drawImage(this.canvas,
f+m,g,k,this.fontSize,c,d,k,this.fontSize),c+=k+this.letterSpacing))}};Font.White=new Font("assets/font/text_white.png",36,384,12);Font.Violet=new Font("assets/font/text_violet.png",36,384,12);Font.Yellow=new Font("assets/font/text_yellow.png",36,384,12);Font.Gold=new Font("assets/font/text_gold.png",36,384,12);
var NumberFont=function(a,c,b,d){Font.call(this,a,c,b,d||8);this.renderString=function(a,b,c,d){b=""+b;for(var e=0,f=b.length,k;e<f;++e)k=b.charCodeAt(e),47>k||57<k||(a.drawImage(this.canvas,(k-47)*this.fontSize,0,this.fontSize,this.fontSize,c,d,this.fontSize,this.fontSize),c+=this.fontSize+this.letterSpacing)};this.getWidth=function(a){return(a+"").length*d}};NumberFont.prototype=Object.create(Font.prototype);NumberFont.White=new NumberFont("assets/font/numbers_white.png",88,8,8);
NumberFont.Red=new NumberFont("assets/font/numbers_red.png",88,8,8);
var Display=function(){var a=[],c=function(b){for(var c=0,e=a.length;c<e;++c)b(a[c])};this.addComponent=function(b){a.push(b);a.sort(function(a,b){return a.zIndex-b.zIndex})};this.tick=function(a){c(function(b){b.visible&&(b.tick(a),b.postTick(a))})};this.render=function(a){c(function(b){b.visible&&(b.preRender(a),b.render(a),b.postRender(a))})}},DisplayComponent=function(){var a=!1,c=0,b=0,d=0,e=0;this.zIndex=this.y=this.x=0;this.visible=!0;this.fxSpeed=300;this.fxAccuracy=20;var f=function(){return Math.sqrt(Math.pow(this.x-
c,2)+Math.pow(this.y-b,2))}.bind(this);this.preRender=function(a){a.translate(this.x,this.y)};this.render=function(a){};this.postRender=function(a){a.translate(-this.x,-this.y)};this.tick=function(a){};this.postTick=function(l){a&&(f()>this.fxAccuracy?(c>this.x?this.x+=l/this.fxSpeed*d:c<this.x&&(this.x-=l/this.fxSpeed*d),b>this.y?this.y+=l/this.fxSpeed*e:b<this.y&&(this.y-=l/this.fxSpeed*e)):(a=!1,this.x=c,this.y=b,e=d=b=c=0))};this.isAnimating=function(){return a};this.moveTo=function(f,k){c=f;
b=k;d=Math.abs(this.x-c);e=Math.abs(this.y-b);a=!0}},PathNode=function(a,c,b,d){this.x=a;this.y=c;this.f=b||0;this.g=d||0;this.hash="PathNode@"+a+","+c;this.predecessor=null;this.successors=[];this.discoverSuccessors=function(a){for(var b=0,c=PathNode.successorVects.length,d;b<c;++b)d=PathNode.successorVects[b],a.isInvalid(this.x+d.dX,this.y+d.dY)||this.successors.push(new PathNode(this.x+d.dX,this.y+d.dY))}};PathNode.successorVects=[{dX:-1,dY:0},{dX:0,dY:-1},{dX:1,dY:0},{dX:0,dY:1}];
var PriorityQueue=function(){var a=[],c={},b=function(){a.sort(function(a,b){return c[a].priority-c[b].priority})};this.size=function(){return a.length};this.get=function(a){return c[a.hash]};this.insert=function(d,e){a.push(d.hash);c[d.hash]={data:d,priority:e};b()};this.contains=function(a){return void 0!==c[a.hash]};this.removeMin=function(){if(0<a.length){var b=c[a.shift()].data;delete c[b.hash];return b}return null};this.decreaseKey=function(a,e){c[a.hash].priority-=e;b()}},AStar=function(a,
c,b,d,e,f){this.invalidFields=Utils.merge(f?[]:a.getFieldsWithEntites(),a.map.getSolids());this.isInvalid=function(b,c){if(0>b||0>c||b>=a.map.gridWidth||c>=a.map.gridHeight)return!0;for(var d=0,g=this.invalidFields.length;d<g;++d)if(b>=this.invalidFields[d].x&&b<this.invalidFields[d].x+1&&c>=this.invalidFields[d].y&&c<this.invalidFields[d].y+1)return!0;return!1};var l=new PathNode(d,e),k=new PriorityQueue,n={add:function(a){n[a.hash]=a},contains:function(a){return void 0!==n[a.hash]}};k.insert(new PathNode(c,
b),0);var h=function(a){a.discoverSuccessors(this);for(var b=0,c=a.successors.length,g;b<c;++b)if(g=a.successors[b],!n.contains(g)){var f=a.g+1;k.contains(g)&&f>=k.get(g).g||(g.predecessor=a,g.g=f,f+=Math.abs(g.x-d)+Math.abs(g.y-e),k.contains(g)?k.decreaseKey(g,f):k.insert(g,f))}}.bind(this);this.findPath=function(){PerformanceCounter.currentColor="rgba(255, 0, 0, .9)";if(this.isInvalid(d,e))return[];do{var a=k.removeMin();if(a.hash===l.hash){var b=[];do b.unshift(a),a=a.predecessor;while(null!==
a.predecessor);return b}n.add(a);h(a)}while(0<k.size());return[]}},Explorer={board:null,cache:{},clearCache:function(){Explorer.cache!=={}&&(Explorer.cache={})},passThruCache:function(a,c,b){return Explorer.cache[a]?(PerformanceCounter.currentColor="rgba(0, 0, 255, .9)",Explorer.cache[a]):Explorer.cache[a]=c.apply(Explorer,b)},foundField:function(a,c,b){for(var d=0,e=b.length;d<e;++d)if(b[d][0]===a&&b[d][1]===c)return!0;return!1},isValidField:function(a,c,b,d,e){if(b===a&&d===c)return!1;a=(new AStar(Explorer.board,
a,c,b,d,e)).findPath();return 0<a.length?a:!1},discoverFields:function(a,c,b){var d=[],e=c*c,f=a.gridX;a=a.gridY;for(var l,k=f-c;k<=f+c;++k)for(var n=a-c;n<=a+c;++n)if(Utils.getDistance2(f,a,k,n)<=e&&!Explorer.foundField(k,n,d)&&(l=Explorer.isValidField(f,a,k,n,b),!1!==l&&0!==l.length))for(var h=0,m=l.length;h<m;++h)Explorer.foundField(l[h].x,l[h].y,d)||d.push([l[h].x,l[h].y]);return d},discoverWalkables:function(a){return Explorer.passThruCache("walkables",Explorer.discoverFields,[a,a.stats.walkRadius,
!1])},discoverAttackables:function(a){return Explorer.passThruCache("attackables",Explorer.discoverFields,[a,a.stats.attackRadius,!0])},discoverEntitiesInRadius:function(a,c,b){return Explorer.passThruCache("entitiesInRadius@"+a+","+c+"/"+b,function(a,b,c){for(var d=[],e=c*c,f,h=a-c;h<=a+c;++h)for(var m=b-c;m<=b+c;++m)f=Explorer.board.getEntityAtXY(h,m),null!==f&&!f.isDead()&&Utils.getDistance2(a,b,h,m)<=e&&d.push(f);return d},[a,c,b])}},StateBasedGame=function(a,c){this.screenNode=a;this.settings=
Utils.extend(StateBasedGame.defaultSettings,c);this.screenNode instanceof HTMLCanvasElement||console.error("provided screenNode is not a canvas!");this.context2d=this.screenNode.getContext("2d");var b=0,d={},e="",f="",l=!1,k=!1,n=0,h=0,m=[],q=[],p=[!1,!1,!1];this.init=function(){this.initCanvas();this.initEvents();this.initStates()};this.initCanvas=function(){this.setSize(this.settings.screenWidth,this.settings.screenHeight);this.setScale(this.settings.scale);this.setPixelated(this.settings.pixelated);
this.setFont(this.settings.font);this.screenNode.addEventListener("contextmenu",function(a){a.preventDefault()})};this.initEvents=function(){this.screenNode.addEventListener("click",function(a){if("function"===typeof d[e].onMouseClick)d[e].onMouseClick(a)});this.screenNode.addEventListener("mousedown",function(a){p[a.which-1]=!0;if("function"===typeof d[e].onMouseDown)d[e].onMouseDown(a)}.bind(this));this.screenNode.addEventListener("mouseup",function(a){p[a.which-1]=!1;if("function"===typeof d[e].onMouseUp)d[e].onMouseUp(a)}.bind(this));
this.screenNode.addEventListener("mousemove",function(a){if("function"===typeof d[e].onMouseMove)d[e].onMouseMove(a)}.bind(this));document.addEventListener("keydown",function(a){q[a.keyCode]=!0;if("function"===typeof d[e].onKeyDown)d[e].onKeyDown(a)}.bind(this));document.addEventListener("keyup",function(a){q[a.keyCode]=!1;if("function"===typeof d[e].onKeyUp)d[e].onKeyUp(a)}.bind(this))};this.initStates=function(){for(var a in d)d.hasOwnProperty(a)&&d[a].init()};this.addState=function(a,b){d[a]=b;
""===e&&(e=a)};this.switchState=function(a){d[a]||console.error("no gamestate w/ id `"+a+"`!");a===e?console.warn("tried to switch into active gamestate, ignoring."):(l=!0,f=a)};this.setPixelated=function(a){this.screenNode.style.imageRendering=a?"pixelated":"auto";this.context2d.imageSmoothingEnabled=!a};this.setSize=function(a,b){this.screenNode.width=a;this.screenNode.height=b};this.setScale=function(a){this.screenNode.style.transform="translateX(-50%) translateY(-50%) scale("+a+")"};this.setFont=
function(a){this.context2d.font=a;this.context2d.textBaseline="top"};this.ctxClearScreen=function(){this.context2d.clearRect(0,0,this.settings.screenWidth,this.settings.screenHeight)};this.mouseKeyPressed=function(a){return"undefined"===typeof a?p[0]||p[1]||p[2]:p[a]};this.keyboardKeyPressed=function(a){return!!q[a]};this.scheduleTask=function(a,b){m.push({delay:a,callback:b})};this.tick=function(a){l||k||d[e].tick(a);for(var b=0,c=m.length;b<c;++b)m[b].delay-=a,0>=m[b].delay&&(m[b].callback(),m.splice(b,
1),--c);h=a};this.render=function(a){d[e].render(a);l?1>n?n+=h/750:(l=!1,k=!0,e=f):k&&(0<n?n-=h/750:k=!1);if(l||k)a.fillStyle="rgba(0, 0, 0, "+Math.max(Math.min(n,1),0)+")",a.fillRect(0,0,this.settings.screenWidth,this.settings.screenHeight)};this.cycle=function(){var a=Date.now();this.ctxClearScreen();this.tick(a-b);this.render(this.context2d);b=a;window.requestAnimationFrame(this.cycle.bind(this))};this.start=function(){window.setTimeout(function(){Art.isReady()?(this.screenNode.focus(),b=Date.now(),
window.requestAnimationFrame(this.cycle.bind(this))):this.start()}.bind(this),10)}};StateBasedGame.defaultSettings={screenWidth:240,screenHeight:160,scale:1,pixelated:!0,font:"14px sans-serif"};
var GameState=function(a){this.game=a;this.init=function(){};this.tick=function(){};this.render=function(){};this.onMouseClick=function(){};this.onMouseDown=function(){};this.onMouseUp=function(){};this.onMouseMove=function(){};this.onKeyDown=function(){};this.onKeyUp=function(){}},Entity=function(a){var c=0,b=0,d=!1,e=!1,f=[];this.arrived=!1;var l=Entity.direction.NORTH,k=Entity.state.IDLE;this.uid=Utils.getUID();this.stats=a;a=0;for(var n=this.stats.inventory.length;a<n;++a)this.stats.inventory[a].apply(this);
this.height=this.screenY=this.screenX=this.gridY=this.gridX=0;this.speed=1.93;this.animations={};this.popsDisplay=null;var h=!0,m=0,q=0;this.isBlinking=!1;var p=800;this.pointInBounds=function(a,b){return a>=this.gridX-.5&&a<this.gridX+.5&&b>=this.gridY-.5&&b<this.gridY+.5};this.isWalking=function(){return e};this.setX=function(a){this.setXY(a,this.gridY)};this.setY=function(a){this.setXY(this.gridX,a)};this.setXY=function(a,b){this.gridX=a;this.gridY=b;this.screenX=a*Utils.sin_cos_45-b*Utils.sin_cos_45;
this.screenY=a*Utils.sin_cos_45+b*Utils.sin_cos_45;this.screenX=Math.round(this.screenX*Map.tileSize);this.screenY=Math.round(this.screenY*Map.tileSize*.5)};this.turn=function(a){l=a};this.turnToDirectionByAngle=function(a){this.turn(Entity.getDirectionByAngle(a))};this.turnToXY=function(a,b){this.turn(Entity.getDirectionByAngle(Utils.getAngleDegrees(this.gridX,this.gridY,a,b)))};this.turnTo=function(a){this.turnToXY(a.gridX,a.gridY)};this.setState=function(a){k=a;this.getCurrentAnimation().reset()};
this.getState=function(){return k};this.isDead=function(){return k===Entity.state.DEAD};this.canAttack=function(){return 0<=this.stats.mpLeft-this.stats.attackCost?!0:!1};this.attack=function(){this.setState(Entity.state.ATTACKING);this.stats.mpLeft-=this.stats.attackCost;h=!0;m=0};this.receiveAttack=function(a){var b=Entity.getDamage(a,this);a.stats.isMage||this.turnTo(a);0>b?(this.evade(),this.popsDisplay.floatArtUp(Art.miss,this.screenX-12.5,this.screenY-28)):(this.defend(),this.popsDisplay.floatTextUp(NumberFont.Red,
b,this.screenX-NumberFont.Red.getWidth(b)/2,this.screenY-28),this.stats.hpLeft=Math.max(this.stats.hpLeft-b,0))};this.defend=function(){q=this.screenX;this.setState(Entity.state.DEFENDING);h=!0;m=0};this.evade=function(){q=this.screenX;this.setState(Entity.state.EVADING);h=!0;m=0};this.getCurrentAnimation=function(){return this.animations[k+"_"+l]};this.getCurrentDirection=function(){return l};this.getDirectionVect=function(a){var b={x:-1,y:-1};switch(a){case Entity.direction.NORTH:b.x=this.gridX;
b.y=this.gridY+1;break;case Entity.direction.WEST:b.x=this.gridX+1;b.y=this.gridY;break;case Entity.direction.SOUTH:b.x=this.gridX;b.y=this.gridY-1;break;case Entity.direction.EAST:b.x=this.gridX-1,b.y=this.gridY}return b};this.walkPath=function(a){e=!0;f=a;this.arrived=!1};this.walkTo=function(a){var e=null;c=a.x;b=a.y;c<this.gridX?e=Entity.direction.EAST:c>this.gridX?e=Entity.direction.WEST:b<this.gridY?e=Entity.direction.SOUTH:b>this.gridY&&(e=Entity.direction.NORTH);this.turn(e);d=!0};this.stepDirection=
function(a){var e=this.getDirectionVect(a);-1!==e.x&&-1!==e.y&&(c=e.x,b=e.y,this.turn(a),d=!0)};this.getTargetDistance=function(){return Math.sqrt(Math.pow(this.gridX-c,2)+Math.pow(this.gridY-b,2))};this.render=function(a){(!this.isBlinking||this.isBlinking&&400>=p)&&this.getCurrentAnimation().render(a,this.screenX-16,this.screenY-26)};this.tick=function(a){p-=20;0>=p&&(p=800);0>=this.stats.hpLeft&&k!==Entity.state.DEAD&&k!==Entity.state.DEFENDING&&(this.setState(Entity.state.DEAD),this.popsDisplay.hoverArt(Art.stars,
this.screenX-7,this.screenY-32));k!==Entity.state.DEAD&&(this.getCurrentAnimation().tick(a),h&&(m+=a,m>=this.getCurrentAnimation().duration&&(h=!1,m=0,this.setState(Entity.state.IDLE))),d?.1<this.getTargetDistance()?(this.gridX<c?this.setX(this.gridX+a/1E3*this.speed):this.gridX>c&&this.setX(this.gridX-a/1E3*this.speed),this.gridY<b?this.setY(this.gridY+a/1E3*this.speed):this.gridY>b&&this.setY(this.gridY-a/1E3*this.speed)):d=!1:!d&&e&&0<f.length?(this.setXY(Utils.roundPt5(this.gridX),Utils.roundPt5(this.gridY)),
this.walkTo(f.shift())):(this.setXY(Utils.roundPt5(this.gridX),Utils.roundPt5(this.gridY)),e&&0===f.length&&(e=!1,this.arrived=!0)),k===Entity.state.EVADING&&(this.screenX=q-4*Math.sin(m/this.getCurrentAnimation().duration*Math.PI)))}};
Entity.baseStats={side:-1,portrait:null,name:"NULL",walkRadius:1,attackRadius:1,attackRange:0,weaponAttack:1,weaponDefense:1,magicAttack:1,magicDefense:1,hpLeft:1,hpMax:1,mpLeft:1,mpMax:1,accuracy:100,evasiveness:100,inventory:[],isMage:!1,displayClass:"Entity",displayFont:"Gold",attackCost:0,speed:0};Entity.demoInventoryPossibilities=[];Entity.randomIV=function(){return Math.floor(15*Math.random())+1};
Entity.createInstance=function(a,c){for(var b=[],d=0,e=a.demoInventoryPossibilities.length;d<e;++d).5>Math.random()&&3>b.length&&b.push(new a.demoInventoryPossibilities[d]);b=Utils.extend(Utils.extend(Entity.baseStats,a.baseStats),{hpLeft:a.baseStats.hp+Entity.randomIV(),mpLeft:a.baseStats.mp+Entity.randomIV(),weaponAttack:a.baseStats.weaponAttack+Entity.randomIV(),magicAttack:a.baseStats.magicAttack+Entity.randomIV(),accuracy:a.baseStats.accuracy+Entity.randomIV(),evasiveness:a.baseStats.evasiveness+
Entity.randomIV(),speed:a.baseStats.speed+Entity.randomIV(),inventory:b});b.hpMax=b.hpLeft;b.mpMax=b.mpLeft;b.name=Entity.pullRandomName();b.side=c?Entity.ALLIED:Entity.ENEMY;return new a(b)};Entity.ALLIED=0;Entity.ENEMY=1;Entity.state={IDLE:"idle",ATTACKING:"attacking",DEFENDING:"defending",EVADING:"evading",DEAD:"dead"};Entity.direction={NORTH:"north",WEST:"west",SOUTH:"south",EAST:"east"};
Entity.getDirectionByAngle=function(a){a+=45;360<a&&(a-=360);switch(a-a%90){case 0:return Entity.direction.EAST;case 90:return Entity.direction.SOUTH;case 180:return Entity.direction.WEST;case 270:return Entity.direction.NORTH;default:return Entity.direction.SOUTH}};
Entity.getPositionModifier=function(a,c){var b=.5;a.getCurrentDirection()===c.getCurrentDirection()?b=1.5:a.getCurrentDirection()===Entity.direction.NORTH&&c.getCurrentDirection()===Entity.direction.SOUTH||a.getCurrentDirection()===Entity.direction.SOUTH&&c.getCurrentDirection()===Entity.direction.NORTH||a.getCurrentDirection()===Entity.direction.WEST&&c.getCurrentDirection()===Entity.direction.EAST||a.getCurrentDirection()===Entity.direction.EAST&&c.getCurrentDirection()===Entity.direction.WEST||
(b=1);return b};Entity.willHit=function(a,c){return Entity.getPositionModifier(a,c)*(a.stats.accuracy/a.stats.evasiveness)>=Math.random()};Entity.getDamage=function(a,c){if(!Entity.willHit(a,c))return-1;var b=a.stats.isMage?a.stats.magicAttack:a.stats.weaponAttack,d=a.stats.isMage?c.stats.magicDefense:c.stats.weaponDefense;c=Entity.getPositionModifier(a,c);return Math.max(Math.floor(b/d*5*c*(100*Math.random()<a.stats.accuracy/2?2:1)*(.15*Math.random()+.85)),1)};
Entity.getRandomDirection=function(){return[Entity.direction.NORTH,Entity.direction.WEST,Entity.direction.SOUTH,Entity.direction.EAST][Math.floor(4*Math.random())]};Entity.randomNames="Alcest Anry Anton Arthur Augusto Azimov Baldwin Basil Bellini Benkman Bensom Benton Bernardo Bingley Bismark Bjorn Brean Brish Brown Brunhart Caines Camus Carlos Carrelo Carson Cassidy Cesare Chad Chandler Chaka Chaucer Chelney Chibot Chita Clay Cliffor Cochran Conner Conrad Cooper Cox Crout Crowe Cuthbert Darcy Darios Darren Dave David Deen Deisel Deiter Devange Devoe Dickens Dino Domenic Domie Douglas Duler Dwight Dylan Edmund Elias Elija Elmon Elnan Elvos Emet Eugene Euver Evor Finnagan Foobar Ford Frantz Gallahan Galor Gavvar Gelarto Georg Gerome Giger Gilbert Gillis Godfrey Goodwin Gotwald Graham Grandi Guin Gustav Hans Hardy Hastings Heath Higgins Hodges Homer Hoffman Holbin Hopper Hores Ichbod Iden Ingg Isaac Istavan Ivolt Jalam Jang Jareth Javet Juris Jon Jonathan Johanes Joseph Joshua Julian Karl Kemal Kenneth Kent Kestner Kief Kilov Kingsley Kipper Larga Lendle Lenny Leo Leonard Leroy Lex Lester Lezaford Liam Lidenbok Lief Lizzo Loki Looie Lorek Luan Lucas Lukino Lunais Macgregor Mack Mackenroe Major Malchelo Marius Martinez Marty Matias Mauritz Meiyou Melanor Mendoza Messara Michael Michaelov Mick Milay Miles Milton Moby Mondo Monid Monte Moritz Morry Mosley Muglio Mujika Mulat Nabkov Nansen Nat Nate Neddy Neksu Nelin Nelson Nero Neuman Nevil Nikolai Nils Nobel Noman Nol Norbert Nothclif Nume Nusratt Ocon Odonel Oigen Olgan Olint Olivar Orsiny Oskar Pablo Parish Pedro Peet Phil Raif Rain Ramses Ramsey Ranbard Randorf Raol Ravel Rayton Ricardo Rickman Ridley Rober Rodrigo Rolan Roland Rolf Rockwell Roker Rooster Sabatini Safra Sale Salsbar Sammy Sandath Satir Schneider Seleucos Selm Seneka Seth Sharu Shudmeyer Shultz Sigmund Silac Simon Skimble Slamen Smyth Soala Sotel Spengler Stan Stanz Staring Stuart Syrus Tavana Tennesey Thane Thedoric Thenardi Theodore Thomson Thorton Timothy Toby Tonio Tony Toynbee Travis Trevor Turner Udvil Vasil Velasquez Victor Visconti Wagner Watoo Watz Wells Werner Wilder Wilfred Willy Woolwort Yenke Yolando Yuri Yutolio Yuwain Zeeman Zenelly Zoik Zwingley".split(" ");
Entity.pullRandomName=function(){return Entity.randomNames.splice(Math.floor(Math.random()*Entity.randomNames.length),1)[0]||"NO NAME LEFT"};
var Solid=function(a,c,b){this.x=a;this.y=c;this.art=b;this.height=24;this.screenX=this.x*Utils.sin_cos_45-this.y*Utils.sin_cos_45;this.screenY=this.x*Utils.sin_cos_45+this.y*Utils.sin_cos_45;this.screenX=Math.floor(this.screenX*Map.tileSize)-12;this.screenY=Math.floor(this.screenY*Map.tileSize*.5)-12;this.render=function(a){this.art.render(a,this.screenX,this.screenY)}},Map=function(a,c,b,d){var e=[];this.gridHeight=this.gridWidth=20;this.translateX=-b;this.translateY=-d;this.renderBackground=function(a){c.render(a,
0,0)};this.renderMap=function(b){a.render(b,this.translateX,this.translateY)};this.getSolids=function(){return e};this.addSolid=function(a){e.push(a)};this.eachSolid=function(a){for(var b=0,c=e.length;b<c;++b)a(e[b])};this.isSolid=function(a,b){var c=!1;e.forEach(function(d){d.x<=a&&d.y<=b&&d.x+1>a&&d.y+1>b&&(c=!0)});return c};this.isOutOfBounds=function(a,b){return 0>a||0>b||a>this.gridWidth||b>this.gridHeight}};Map.tileSize=24;
var Board=function(a){var c=new Display,b=new Pops;c.addComponent(b);var d={};this.centerX=0;this.centerY=120;var e=function(a){for(var b in d)if(d.hasOwnProperty(b)&&!1===a(d[b]))break},f=null;this.map=a;var l=0,k=0,n=[],h=[];this.showAttackables=this.showWalkables=!1;var m=[],q=0,p=null,g=0,u=0,w=0;this.playAnimation=function(a,b,c,d){p=a;g=b;u=c;w=d};this.stopAnimation=function(){p=null};this.attackXY=function(a,b,c){a.turnToXY(b,c);a.stats.isMage&&this.playAnimation(Animation.thunder,720,Math.floor(((b-
.5)*Utils.sin_cos_45-(c+.5)*Utils.sin_cos_45)*Map.tileSize)+1,Math.floor(((b-.5)*Utils.sin_cos_45+(c+.5)*Utils.sin_cos_45)*Map.tileSize*.5)+1)};this.pointAt=function(a,b){f={gridX:a,gridY:b,screenX:Math.floor(((a-.5)*Utils.sin_cos_45-(b+.5)*Utils.sin_cos_45)*Map.tileSize)+1,screenY:Math.floor(((a-.5)*Utils.sin_cos_45+(b+.5)*Utils.sin_cos_45)*Map.tileSize*.5)+1,arrowTop:f?f.arrowTop:0,arrowTimer:f?f.arrowTimer:0}};this.unPoint=function(){f=null};this.unBlink=function(){e(function(a){a.isBlinking=!1})};
this.getEntities=function(a,b){var c=[];e(function(d){d.isDead()||d.stats[a]!==b||c.push(d)});return c};this.getAllEntities=function(){var a=[];e(function(b){a.push(b)});return a};this.getEntityAtXY=function(a,b){var c=null;e(function(d){if(a>=d.gridX-.5&&a<d.gridX+.5&&b>=d.gridY-.5&&b<d.gridY+.5)return c=d,!1});return c};this.getEntityByUID=function(a){return d[a]||null};this.getCurrentEntity=function(){return d[m[q]]||null};this.canGoOn=function(){var a=0,b=0;e(function(c){0<c.stats.hpLeft&&(c.stats.side===
Entity.ENEMY?++a:++b)});return a&&b};this.getEnemyCount=function(){var a=0;e(function(b){0<b.stats.hpLeft&&b.stats.side===Entity.ENEMY&&++a});return a};this.getAllyCount=function(){var a=0;e(function(b){0<b.stats.hpLeft&&b.stats.side===Entity.ALLIED&&++a});return a};this.cycleNextEntity=function(){if(!this.canGoOn())return!1;++q===m.length&&(q=0);0>=d[m[q]].stats.hpLeft&&this.cycleNextEntity();return!0};this.spawnEntity=function(a,b){a=Entity.createInstance(a,b);this.addEntity(a,!0)};this.addEntity=
function(c,e){var f=Utils.getUID();c.uid=f;c.popsDisplay=b;d[f]=c;m.push(f);m.sort(function(a,b){return d[b].stats.speed-d[a].stats.speed});if(e){for(f=e=-1;-1===e||-1===f||this.isEntity(e,f)||this.map.isSolid(e,f);)e=Math.floor(Math.random()*a.gridWidth)+.5,f=Math.floor(Math.random()*a.gridHeight)+.5;c.setXY(e,f);c.turn(Entity.getRandomDirection())}};this.centerOnEntity=function(a){this.centerX=a.screenX;this.centerY=a.screenY};this.centerOnGridXY=function(a,b){a=this.toScreenXY(a,b);centerX=Math.floor(a.x);
centerY=Math.floor(a.y)};this.getFieldsWithEntites=function(){var a=[];e(function(b){a.push({x:Math.floor(b.gridX),y:Math.floor(b.gridY)})});return a};this.isEntity=function(a,b){var c=!1;e(function(d){if(a>=d.gridX-.5&&a<d.gridX+.5&&b>=d.gridY-.5&&b<d.gridY+.5)return c=!0,!1});return c};this.isAliveEntity=function(a,b){var c=null;return null!==(c=this.getEntityAtXY(a,b))&&!c.isDead()};this.isWalkable=function(a,b){for(var c=0,d=n.length;c<d;++c)if(n[c][0]-.5<=a&&n[c][0]+.5>a&&n[c][1]-.5<=b&&n[c][1]+
.5>b)return!0;return!1};this.isAttackable=function(a,b){for(var c=0,d=h.length;c<d;++c)if(h[c][0]-.5<=a&&h[c][0]+.5>a&&h[c][1]-.5<=b&&h[c][1]+.5>b)return!0;return!1};this.entityDiscover=function(a){Explorer.clearCache();n=Explorer.discoverWalkables(d[a]);h=Explorer.discoverAttackables(d[a])};this.getWalkables=function(){return n};this.getAttackables=function(){return h};this.tick=function(a){e(function(b){b.tick(a)});Animation.boardWalkableFieldsEnemy.tick(a);Animation.boardWalkableFieldsAllied.tick(a);
Animation.boardWalkableFieldsImportant.tick(a);Animation.boardWalkableFieldsNeutral.tick(a);f&&(f.arrowTop=6*Math.sin(f.arrowTimer/175),f.arrowTimer+=a);p&&(p.tick(a),g-=a,0>=g&&this.stopAnimation());c.tick(a)};this.renderEntitiesAndSolids=function(a){var b=[];e(function(a){b.push(a)});this.map.eachSolid(function(a){b.push(a)});b.sort(function(a,b){return a.screenY+a.height-(b.screenY+b.height)});for(var c=0,d=b.length;c<d;++c)b[c].render(a)};this.highlightFields=function(a,b,c){for(var d=0,e=c.length;d<
e;++d){var f=(c[d][0]-1)*Utils.sin_cos_45-c[d][1]*Utils.sin_cos_45,g=(c[d][0]-1)*Utils.sin_cos_45+c[d][1]*Utils.sin_cos_45,f=Math.floor(f*Map.tileSize),g=Math.floor(g*Map.tileSize*.5);b.render(a,f,g)}};this.render=function(a){this.map.renderBackground(a);l=a.canvas.width/2-this.centerX;k=a.canvas.height/2-this.centerY;a.translate(l,k);this.map.renderMap(a);this.showWalkables?this.highlightFields(a,this.getCurrentEntity().stats.side===Entity.ENEMY?Animation.boardWalkableFieldsEnemy:Animation.boardWalkableFieldsAllied,
n):this.showAttackables&&this.highlightFields(a,Animation.boardWalkableFieldsNeutral,h);this.getCurrentEntity()&&!this.getCurrentEntity().isWalking()&&Animation.boardWalkableFieldsImportant.render(a,this.getCurrentEntity().screenX-17,this.getCurrentEntity().screenY-9);f&&Art.boardPointerField.render(a,f.screenX,f.screenY);this.renderEntitiesAndSolids(a);f&&Art.boardPointerArrow.render(a,f.screenX+12,f.screenY-8-36+f.arrowTop);p&&p.render(a,u-150+17,w-300);c.render(a);a.resetTransform()};this.toGridXY=
function(a,b){a-=l;b-=k;a/=Map.tileSize;b=b/Map.tileSize/.5;return{x:-(a*-Utils.sin_cos_45+b*-Utils.sin_cos_45),y:a*-Utils.sin_cos_45-b*-Utils.sin_cos_45}};this.toScreenXY=function(a,b){a=a*Utils.sin_cos_45-b*Utils.sin_cos_45;return{x:Math.floor(a*Map.tileSize),y:Math.floor(a*Map.tileSize*.5)}}},Staging=function(a){var c=a||null,b=null,d={};this.addTrigger=function(a,b){for(var c=0,e=a.length;c<e;++c)void 0===d[a[c]]&&(d[a[c]]=[]),d[a[c]].push(b)};this.getCurrent=function(){return c};this.getLast=
function(){return b};this.setCurrent=function(a){b=c;c=a;if(void 0!==d[a])for(var e=0,l=d[a].length;e<l;++e)d[a][e]()};this.currentIs=function(a){return"number"===typeof a?a===c:-1<a.indexOf(c)};this.lastWas=function(a){return"number"===typeof a?a===b:-1<a.indexOf(b)}},CorrectionSet={BLUE_RED:[new ColorCorrection(ColorChannel.CYAN,{C:-1,M:1,Y:1,K:0}),new ColorCorrection(ColorChannel.BLUE,{C:-1,M:1,Y:4,K:0})],BLUE_YELLOW:[new ColorCorrection(ColorChannel.CYAN,{C:-1,M:-1,Y:3,K:0}),new ColorCorrection(ColorChannel.BLUE,
{C:-1,M:-1,Y:3,K:0}),new ColorCorrection(ColorChannel.YELLOW,{C:-1,M:-1,Y:3,K:-3})],BLUE_GREEN:[new ColorCorrection(ColorChannel.CYAN,{C:2,M:0,Y:3,K:0}),new ColorCorrection(ColorChannel.BLUE,{C:2,M:0,Y:3,K:0}),new ColorCorrection(ColorChannel.GREEN,{C:0,M:0,Y:0,K:-1.25})],GREEN_RED:[new ColorCorrection(ColorChannel.GREEN,{C:-3,M:1.5,Y:1.5,K:0}),new ColorCorrection(ColorChannel.YELLOW,{C:-3,M:1.5,Y:1.5,K:.5})]};Art.splash=new Art("assets/splash.png");Art.howto=new Art("assets/howto.png");
Art.inventory=new Art("assets/overlay/inventory.png");Art.statsBackgroundLeft=[new Art("assets/display/stats/allied_left.png"),new Art("assets/display/stats/enemy_left.png")];Art.statsBackgroundRight=[new Art("assets/display/stats/allied_right.png"),new Art("assets/display/stats/enemy_right.png")];Art.menuActionBackground=new Art("assets/display/main/background.png");
Art.menuActionSelected=[new Art("assets/display/main/action_move_selected.png"),new Art("assets/display/main/action_attack_selected.png"),new Art("assets/display/main/action_wait_selected.png")];Art.menuActionDisabled=[new Art("assets/display/main/action_move_disabled.png"),new Art("assets/display/main/action_attack_disabled.png"),new Art("assets/display/main/action_wait_disabled.png")];Art.boardPointerField=new Art("assets/misc/pointer_bottom.png");Art.boardPointerArrow=new Art("assets/misc/pointer_top.png");
Art.mapSolidRock=new Art("assets/solids/rock.png");Art.mapAisenfieldLayer=new Art("assets/maps/aisenfield/layer_0.png");Art.mapAisenfieldBackground=new Art("assets/maps/aisenfield/background.png");Art.portraitSoldierAllied=new Art("assets/soldier/portrait.png");Art.portraitSoldierEnemy=new Art("assets/soldier/portrait.png",CorrectionSet.BLUE_RED);Art.portraitMogryAllied=new Art("assets/mogry/portrait.png");Art.portraitMogryEnemy=new Art("assets/mogry/portrait.png",CorrectionSet.BLUE_RED);
Art.miss=new Art("assets/display/pops/miss.png");Art.stars=new Art("assets/display/pops/stars.png");Art.mode=[new Art("assets/display/mode/attack.png"),new Art("assets/display/mode/move.png"),new Art("assets/display/mode/wait.png")];Art.itemSword=new Art("assets/items/sword/icon.png");Art.itemChestplate=new Art("assets/items/chestplate/icon.png");Art.itemShield=new Art("assets/items/shield/icon.png");Art.itemBoots=new Art("assets/items/boots/icon.png");Art.itemWand=new Art("assets/items/wand/icon.png");
Art.inventoryLayer1=new Art("assets/inventory/bg_layer1.png");Art.inventoryLayer2=new Art("assets/inventory/bg_layer2.png");Animation.thunder=new Animation([{path:"assets/misc/thunder_0.png",duration:240},{path:"assets/misc/thunder_1.png",duration:240}]);
Animation.boardWalkableFieldsAllied=new Animation([{path:"assets/misc/field0.png",duration:150},{path:"assets/misc/field1.png",duration:150},{path:"assets/misc/field2.png",duration:150},{path:"assets/misc/field3.png",duration:150},{path:"assets/misc/field4.png",duration:150},{path:"assets/misc/field5.png",duration:150},{path:"assets/misc/field6.png",duration:150},{path:"assets/misc/field7.png",duration:150},{path:"assets/misc/field8.png",duration:150},{path:"assets/misc/field9.png",duration:150}]);
Animation.boardWalkableFieldsEnemy=Animation.boardWalkableFieldsAllied.instance(CorrectionSet.BLUE_RED);Animation.boardWalkableFieldsNeutral=Animation.boardWalkableFieldsAllied.instance(CorrectionSet.BLUE_YELLOW);Animation.boardWalkableFieldsImportant=Animation.boardWalkableFieldsAllied.instance(CorrectionSet.BLUE_GREEN);
Animation.soldierIdleNorth=new Animation([{path:"assets/soldier/idle/north_0.png",duration:300},{path:"assets/soldier/idle/north_1.png",duration:150},{path:"assets/soldier/idle/north_2.png",duration:300},{path:"assets/soldier/idle/north_1.png",duration:150}]);Animation.soldierIdleWest=new Animation([{path:"assets/soldier/idle/west_0.png",duration:300},{path:"assets/soldier/idle/west_1.png",duration:150},{path:"assets/soldier/idle/west_2.png",duration:300},{path:"assets/soldier/idle/west_1.png",duration:150}]);
Animation.soldierIdleSouth=new Animation([{path:"assets/soldier/idle/south_0.png",duration:300},{path:"assets/soldier/idle/south_1.png",duration:150},{path:"assets/soldier/idle/south_2.png",duration:300},{path:"assets/soldier/idle/south_1.png",duration:150}]);Animation.soldierIdleEast=new Animation([{path:"assets/soldier/idle/east_0.png",duration:300},{path:"assets/soldier/idle/east_1.png",duration:150},{path:"assets/soldier/idle/east_2.png",duration:300},{path:"assets/soldier/idle/east_1.png",duration:150}]);
Animation.soldierAttackingNorth=new Animation([{path:"assets/soldier/idle/north_1.png",duration:100},{path:"assets/soldier/attacking/north_1.png",duration:100},{path:"assets/soldier/attacking/north_2.png",duration:400}],null,!0);Animation.soldierAttackingWest=new Animation([{path:"assets/soldier/idle/west_1.png",duration:100},{path:"assets/soldier/attacking/west_1.png",duration:100},{path:"assets/soldier/attacking/west_2.png",duration:400}],null,!0);
Animation.soldierAttackingSouth=new Animation([{path:"assets/soldier/idle/south_1.png",duration:100},{path:"assets/soldier/attacking/south_1.png",duration:100},{path:"assets/soldier/attacking/south_2.png",duration:400}],null,!0);Animation.soldierAttackingEast=new Animation([{path:"assets/soldier/idle/east_1.png",duration:100},{path:"assets/soldier/attacking/east_1.png",duration:100},{path:"assets/soldier/attacking/east_2.png",duration:400}],null,!0);
Animation.soldierDefendingNorth=new Animation([{path:"assets/soldier/idle/north_1.png",duration:130},{path:"assets/soldier/defending/north.png",duration:500}]);Animation.soldierDefendingWest=new Animation([{path:"assets/soldier/idle/west_1.png",duration:130},{path:"assets/soldier/defending/west.png",duration:500}]);Animation.soldierDefendingSouth=new Animation([{path:"assets/soldier/idle/south_1.png",duration:130},{path:"assets/soldier/defending/south.png",duration:500}]);
Animation.soldierDefendingEast=new Animation([{path:"assets/soldier/idle/east_1.png",duration:130},{path:"assets/soldier/defending/east.png",duration:500}]);Animation.soldierEvadingNorth=new Animation([{path:"assets/soldier/evading/north.png",duration:250}]);Animation.soldierEvadingWest=new Animation([{path:"assets/soldier/evading/west.png",duration:250}]);Animation.soldierEvadingSouth=new Animation([{path:"assets/soldier/evading/south.png",duration:250}]);
Animation.soldierEvadingEast=new Animation([{path:"assets/soldier/evading/east.png",duration:250}]);Animation.soldierDeadNorth=new Animation([{path:"assets/soldier/dead/north.png",duration:250}]);Animation.soldierDeadWest=new Animation([{path:"assets/soldier/dead/west.png",duration:250}]);Animation.soldierDeadSouth=new Animation([{path:"assets/soldier/dead/south.png",duration:250}]);Animation.soldierDeadEast=new Animation([{path:"assets/soldier/dead/north.png",duration:250}]);
Animation.enemySoldierIdleNorth=Animation.soldierIdleNorth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierIdleWest=Animation.soldierIdleWest.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierIdleSouth=Animation.soldierIdleSouth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierIdleEast=Animation.soldierIdleEast.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierAttackingNorth=Animation.soldierAttackingNorth.instance(CorrectionSet.BLUE_RED);
Animation.enemySoldierAttackingWest=Animation.soldierAttackingWest.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierAttackingSouth=Animation.soldierAttackingSouth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierAttackingEast=Animation.soldierAttackingEast.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDefendingNorth=Animation.soldierDefendingNorth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDefendingWest=Animation.soldierDefendingWest.instance(CorrectionSet.BLUE_RED);
Animation.enemySoldierDefendingSouth=Animation.soldierDefendingSouth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDefendingEast=Animation.soldierDefendingEast.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierEvadingNorth=Animation.soldierEvadingNorth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierEvadingWest=Animation.soldierEvadingWest.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierEvadingSouth=Animation.soldierEvadingSouth.instance(CorrectionSet.BLUE_RED);
Animation.enemySoldierEvadingEast=Animation.soldierEvadingEast.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDeadNorth=Animation.soldierDeadNorth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDeadWest=Animation.soldierDeadWest.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDeadSouth=Animation.soldierDeadSouth.instance(CorrectionSet.BLUE_RED);Animation.enemySoldierDeadEast=Animation.soldierDeadEast.instance(CorrectionSet.BLUE_RED);
Animation.mogryIdleNorth=new Animation([{path:"assets/mogry/idle/north_0.png",duration:300},{path:"assets/mogry/idle/north_1.png",duration:150},{path:"assets/mogry/idle/north_2.png",duration:300},{path:"assets/mogry/idle/north_1.png",duration:150}]);Animation.mogryIdleWest=new Animation([{path:"assets/mogry/idle/west_0.png",duration:300},{path:"assets/mogry/idle/west_1.png",duration:150},{path:"assets/mogry/idle/west_2.png",duration:300},{path:"assets/mogry/idle/west_1.png",duration:150}]);
Animation.mogryIdleSouth=new Animation([{path:"assets/mogry/idle/south_0.png",duration:300},{path:"assets/mogry/idle/south_1.png",duration:150},{path:"assets/mogry/idle/south_2.png",duration:300},{path:"assets/mogry/idle/south_1.png",duration:150}]);Animation.mogryIdleEast=new Animation([{path:"assets/mogry/idle/east_0.png",duration:300},{path:"assets/mogry/idle/east_1.png",duration:150},{path:"assets/mogry/idle/east_2.png",duration:300},{path:"assets/mogry/idle/east_1.png",duration:150}]);
Animation.mogryAttackingNorth=new Animation([{path:"assets/mogry/attacking/north_0.png",duration:600}],null,!0);Animation.mogryAttackingWest=new Animation([{path:"assets/mogry/attacking/west_0.png",duration:600}],null,!0);Animation.mogryAttackingSouth=new Animation([{path:"assets/mogry/attacking/south_0.png",duration:600}],null,!0);Animation.mogryAttackingEast=new Animation([{path:"assets/mogry/attacking/east_0.png",duration:600}],null,!0);
Animation.mogryDefendingNorth=new Animation([{path:"assets/mogry/idle/north_1.png",duration:130},{path:"assets/mogry/defending/north.png",duration:500}]);Animation.mogryDefendingWest=new Animation([{path:"assets/mogry/idle/west_1.png",duration:130},{path:"assets/mogry/defending/west.png",duration:500}]);Animation.mogryDefendingSouth=new Animation([{path:"assets/mogry/idle/south_1.png",duration:130},{path:"assets/mogry/defending/south.png",duration:500}]);
Animation.mogryDefendingEast=new Animation([{path:"assets/mogry/idle/east_1.png",duration:130},{path:"assets/mogry/defending/east.png",duration:500}]);Animation.mogryEvadingNorth=new Animation([{path:"assets/mogry/evading/north.png",duration:250}]);Animation.mogryEvadingWest=new Animation([{path:"assets/mogry/evading/west.png",duration:250}]);Animation.mogryEvadingSouth=new Animation([{path:"assets/mogry/evading/south.png",duration:250}]);
Animation.mogryEvadingEast=new Animation([{path:"assets/mogry/evading/east.png",duration:250}]);Animation.mogryDeadNorth=new Animation([{path:"assets/mogry/dead/north.png",duration:250}]);Animation.mogryDeadWest=new Animation([{path:"assets/mogry/dead/west.png",duration:250}]);Animation.mogryDeadSouth=new Animation([{path:"assets/mogry/dead/south.png",duration:250}]);Animation.mogryDeadEast=new Animation([{path:"assets/mogry/dead/north.png",duration:250}]);Animation.enemyMogryIdleNorth=Animation.mogryIdleNorth.instance(CorrectionSet.GREEN_RED);
Animation.enemyMogryIdleWest=Animation.mogryIdleWest.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryIdleSouth=Animation.mogryIdleSouth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryIdleEast=Animation.mogryIdleEast.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryAttackingNorth=Animation.mogryAttackingNorth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryAttackingWest=Animation.mogryAttackingWest.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryAttackingSouth=Animation.mogryAttackingSouth.instance(CorrectionSet.GREEN_RED);
Animation.enemyMogryAttackingEast=Animation.mogryAttackingEast.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDefendingNorth=Animation.mogryDefendingNorth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDefendingWest=Animation.mogryDefendingWest.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDefendingSouth=Animation.mogryDefendingSouth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDefendingEast=Animation.mogryDefendingEast.instance(CorrectionSet.GREEN_RED);
Animation.enemyMogryEvadingNorth=Animation.mogryEvadingNorth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryEvadingWest=Animation.mogryEvadingWest.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryEvadingSouth=Animation.mogryEvadingSouth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryEvadingEast=Animation.mogryEvadingEast.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDeadNorth=Animation.mogryDeadNorth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDeadWest=Animation.mogryDeadWest.instance(CorrectionSet.GREEN_RED);
Animation.enemyMogryDeadSouth=Animation.mogryDeadSouth.instance(CorrectionSet.GREEN_RED);Animation.enemyMogryDeadEast=Animation.mogryDeadEast.instance(CorrectionSet.GREEN_RED);
var Stats=function(a){DisplayComponent.call(this);var c=null,b=Entity.ALLIED,d=null,e="Jackson",f=0,l=0,k=0,n=0,h=null,m=0,q=0,p=0;0===a?(h=Art.statsBackgroundLeft,m=30,p=q=50):(h=Art.statsBackgroundRight,m=12,p=q=32);var g=function(){null!==c&&(b=c.stats.side,d=c.stats.portrait,e=c.stats.name,f=c.stats.hpLeft,l=c.stats.hpMax,k=c.stats.mpLeft,n=c.stats.mpMax)};this.setEntity=function(a){c=a;g()};this.getEntity=function(){return c};this.tick=function(a){g()};this.render=function(g){null!==c&&(h[b].render(g,
0,0),Font.White.renderString(g,e,m,2),NumberFont.White.renderString(g,f+"/"+l,q,16),NumberFont.White.renderString(g,k+"/"+n,p,27),0===a&&d.render(g,-15,-55))}};Stats.prototype=Object.create(DisplayComponent.prototype);
var Pops=function(){DisplayComponent.call(this);var a=[];this.floatArtUp=function(c,b,d,e){a.push({art:c,x:b,y:d,dx:0,dy:-.35,duration:e||750,type:"art",behaviour:"translate"})};this.floatTextUp=function(c,b,d,e,f){a.push({font:c,text:b,x:d,y:e,dx:0,dy:-.35,duration:f||750,type:"text",behaviour:"translate"})};this.hoverArt=function(c,b,d){a.push({art:c,x:b,y:d,oX:b,oY:d,timer:0,type:"art",behaviour:"hover"})};this.tick=function(c){for(var b=0,d=a.length;b<d;++b)"translate"===a[b].behaviour?(a[b].x+=
a[b].dx,a[b].y+=a[b].dy,a[b].duration-=c,0>=a[b].duration&&(a.splice(b,1),--d)):"hover"===a[b].behaviour&&(a[b].y=a[b].oY+4*Math.sin(a[b].timer/1500*2*Math.PI),a[b].timer+=c,1500<=a[b].timer&&(a[b].timer-=1500))};this.render=function(c){for(var b=0,d=a.length;b<d;++b)"art"===a[b].type?a[b].art.render(c,Math.floor(a[b].x),Math.floor(a[b].y)):"text"===a[b].type&&a[b].font.renderString(c,a[b].text,Math.floor(a[b].x),Math.floor(a[b].y))}};Pops.prototype=Object.create(DisplayComponent.prototype);
var Aisenfield=function(){Map.call(this,Art.mapAisenfieldLayer,Art.mapAisenfieldBackground,240,2);this.addSolid(new Solid(2,3,Art.mapSolidRock));this.addSolid(new Solid(5,1,Art.mapSolidRock));this.addSolid(new Solid(13,9,Art.mapSolidRock));this.addSolid(new Solid(7,6,Art.mapSolidRock));this.addSolid(new Solid(10,13,Art.mapSolidRock));this.gridHeight=this.gridWidth=14};Aisenfield.prototype=Object.create(Map.prototype);
var Item=function(){this.name="Item";this.boostText="N/A";this.icon=null;this.boost={hpLeft:0,hpMax:0,mpLeft:0,mpMax:0,walkRadius:0,attackRadius:0,attackRange:0,attackCost:0,weaponAttack:0,weaponDefense:0,magicAttack:0,magicDefense:0};this.apply=function(a){for(var c in this.boost)this.boost.hasOwnProperty(c)&&(a.stats[c]+=this.boost[c])}},Sword=function(){Item.call(this);this.name="Sword";this.icon=Art.itemSword;this.boostText="+5 WATK";this.boost.weaponAttack=5};Sword.prototype=Object.create(Item.prototype);
var Chestplate=function(){Item.call(this);this.name="Chestplate";this.icon=Art.itemChestplate;this.boostText="+3 WDEF";this.boost.weaponDefense=3};Chestplate.prototype=Object.create(Item.prototype);var Shield=function(){Item.call(this);this.name="Shield";this.icon=Art.itemShield;this.boostText="+5 WDEF";this.boost.weaponDefense=5};Shield.prototype=Object.create(Item.prototype);
var Wand=function(){Item.call(this);this.name="Wand";this.icon=Art.itemWand;this.boostText="+10 MATK/MP +1 AC";this.boost.magicAttack=10;this.boost.mpLeft=10;this.boost.mpMax=10;this.boost.attackCost=1};Wand.prototype=Object.create(Item.prototype);var Boots=function(){Item.call(this);this.name="Boots";this.icon=Art.itemBoots;this.boostText="+1 WR";this.boost.walkRadius=1};Boots.prototype=Object.create(Item.prototype);
var Soldier=function(a){Entity.call(this,a);this.stats.side===Entity.ALLIED?(this.stats.portrait=Art.portraitSoldierAllied,this.animations={idle_north:Animation.soldierIdleNorth.instance(),idle_west:Animation.soldierIdleWest.instance(),idle_south:Animation.soldierIdleSouth.instance(),idle_east:Animation.soldierIdleEast.instance(),attacking_north:Animation.soldierAttackingNorth.instance(),attacking_west:Animation.soldierAttackingWest.instance(),attacking_south:Animation.soldierAttackingSouth.instance(),
attacking_east:Animation.soldierAttackingEast.instance(),defending_north:Animation.soldierDefendingNorth.instance(),defending_west:Animation.soldierDefendingWest.instance(),defending_south:Animation.soldierDefendingSouth.instance(),defending_east:Animation.soldierDefendingEast.instance(),evading_north:Animation.soldierEvadingNorth.instance(),evading_west:Animation.soldierEvadingWest.instance(),evading_south:Animation.soldierEvadingSouth.instance(),evading_east:Animation.soldierEvadingEast.instance(),
dead_north:Animation.soldierDeadNorth.instance(),dead_west:Animation.soldierDeadWest.instance(),dead_south:Animation.soldierDeadSouth.instance(),dead_east:Animation.soldierDeadEast.instance()}):(this.stats.portrait=Art.portraitSoldierEnemy,this.animations={idle_north:Animation.enemySoldierIdleNorth.instance(),idle_west:Animation.enemySoldierIdleWest.instance(),idle_south:Animation.enemySoldierIdleSouth.instance(),idle_east:Animation.enemySoldierIdleEast.instance(),attacking_north:Animation.enemySoldierAttackingNorth.instance(),
attacking_west:Animation.enemySoldierAttackingWest.instance(),attacking_south:Animation.enemySoldierAttackingSouth.instance(),attacking_east:Animation.enemySoldierAttackingEast.instance(),defending_north:Animation.enemySoldierDefendingNorth.instance(),defending_west:Animation.enemySoldierDefendingWest.instance(),defending_south:Animation.enemySoldierDefendingSouth.instance(),defending_east:Animation.enemySoldierDefendingEast.instance(),evading_north:Animation.enemySoldierEvadingNorth.instance(),evading_west:Animation.enemySoldierEvadingWest.instance(),
evading_south:Animation.enemySoldierEvadingSouth.instance(),evading_east:Animation.enemySoldierEvadingEast.instance(),dead_north:Animation.enemySoldierDeadNorth.instance(),dead_west:Animation.enemySoldierDeadWest.instance(),dead_south:Animation.enemySoldierDeadSouth.instance(),dead_east:Animation.enemySoldierDeadEast.instance()})};Soldier.prototype=Object.create(Entity.prototype);
Soldier.baseStats={hp:80,mp:10,weaponAttack:7,weaponDefense:8,magicAttack:2,magicDefense:3,accuracy:80,evasiveness:70,walkRadius:3,attackRadius:1,speed:30,displayClass:"Soldier",displayFont:"Yellow"};Soldier.demoInventoryPossibilities=[Sword,Chestplate,Shield,Boots];
var Mogry=function(a){Entity.call(this,a);this.stats.side===Entity.ALLIED?(this.stats.portrait=Art.portraitMogryAllied,this.animations={idle_north:Animation.mogryIdleNorth.instance(),idle_west:Animation.mogryIdleWest.instance(),idle_south:Animation.mogryIdleSouth.instance(),idle_east:Animation.mogryIdleEast.instance(),attacking_north:Animation.mogryAttackingNorth.instance(),attacking_west:Animation.mogryAttackingWest.instance(),attacking_south:Animation.mogryAttackingSouth.instance(),attacking_east:Animation.mogryAttackingEast.instance(),
defending_north:Animation.mogryDefendingNorth.instance(),defending_west:Animation.mogryDefendingWest.instance(),defending_south:Animation.mogryDefendingSouth.instance(),defending_east:Animation.mogryDefendingEast.instance(),evading_north:Animation.mogryEvadingNorth.instance(),evading_west:Animation.mogryEvadingWest.instance(),evading_south:Animation.mogryEvadingSouth.instance(),evading_east:Animation.mogryEvadingEast.instance(),dead_north:Animation.mogryDeadNorth.instance(),dead_west:Animation.mogryDeadWest.instance(),
dead_south:Animation.mogryDeadSouth.instance(),dead_east:Animation.mogryDeadEast.instance()}):(this.stats.portrait=Art.portraitMogryEnemy,this.animations={idle_north:Animation.enemyMogryIdleNorth.instance(),idle_west:Animation.enemyMogryIdleWest.instance(),idle_south:Animation.enemyMogryIdleSouth.instance(),idle_east:Animation.enemyMogryIdleEast.instance(),attacking_north:Animation.enemyMogryAttackingNorth.instance(),attacking_west:Animation.enemyMogryAttackingWest.instance(),attacking_south:Animation.enemyMogryAttackingSouth.instance(),
attacking_east:Animation.enemyMogryAttackingEast.instance(),defending_north:Animation.enemyMogryDefendingNorth.instance(),defending_west:Animation.enemyMogryDefendingWest.instance(),defending_south:Animation.enemyMogryDefendingSouth.instance(),defending_east:Animation.enemyMogryDefendingEast.instance(),evading_north:Animation.enemyMogryEvadingNorth.instance(),evading_west:Animation.enemyMogryEvadingWest.instance(),evading_south:Animation.enemyMogryEvadingSouth.instance(),evading_east:Animation.enemyMogryEvadingEast.instance(),
dead_north:Animation.enemyMogryDeadNorth.instance(),dead_west:Animation.enemyMogryDeadWest.instance(),dead_south:Animation.enemyMogryDeadSouth.instance(),dead_east:Animation.enemyMogryDeadEast.instance()})};Mogry.prototype=Object.create(Entity.prototype);Mogry.baseStats={hp:60,mp:50,weaponAttack:2,weaponDefense:3,magicAttack:6,magicDefense:7,accuracy:60,evasiveness:50,walkRadius:2,attackRadius:4,attackCost:2,attackRange:1,isMage:!0,speed:20,displayClass:"Mogry",displayFont:"Violet"};
Mogry.demoInventoryPossibilities=[Wand,Chestplate,Shield,Boots];
var InventoryDisplay=function(){var a=null,c=!1;this.show=function(){c=!0};this.hide=function(){c=!1};this.isVisible=function(){return c};this.setEntity=function(b){a=b};this.render=function(b){if(c&&null!==a){Art.inventoryLayer2.render(b,0,0);a.stats.portrait.render(b,0,-35);Art.inventoryLayer1.render(b,0,0);Font.White.renderString(b,a.stats.name,47,4);Font[a.stats.displayFont].renderString(b,a.stats.displayClass,47,17);NumberFont.White.renderString(b,a.stats.hpLeft+"/"+a.stats.hpMax,66,31);NumberFont.White.renderString(b,
a.stats.mpLeft+"/"+a.stats.mpMax,66,42);NumberFont.White.renderString(b,Math.floor(a.stats.walkRadius),85,65);NumberFont.White.renderString(b,Math.floor(a.stats.evasiveness),85,78);NumberFont.White.renderString(b,Math.floor(a.stats.weaponAttack),85,99);NumberFont.White.renderString(b,Math.floor(a.stats.weaponDefense),85,111);NumberFont.White.renderString(b,Math.floor(a.stats.magicAttack),85,123);NumberFont.White.renderString(b,Math.floor(a.stats.magicDefense),85,135);for(var d=0,e,f;3>d;++d)void 0===
a.stats.inventory[d]?(e="-",f=""):(e=a.stats.inventory[d].name,f=a.stats.inventory[d].boostText,a.stats.inventory[d].icon.render(b,135,65+24*d)),Font.White.renderString(b,e,153,67+24*d),Font.Gold.renderString(b,f,235-Font.Gold.getWidth(f),79+24*d)}}},Stage={INTRO:0,CYCLE_ENTITY:1,SCROLL_TO_CURRENT:2,AWAIT_MOVE_1:3,WALK_TO_TARGET_1:4,DISPLAY_ATTACK_1:5,AWAIT_MOVE_2:6,WALK_TO_TARGET_2:7,DISPLAY_ATTACK_2:8,SET_WAITING_POSITION:9},AI={WALK:0,ATTACK:1,WAIT:2,knownWalkableEntities:[],knownAttackableEntities:[],
knownWalkableFields:[],decide:function(a,c,b,d){return{decision:a,direction:c,targetX:b,targetY:d}},decideWalkToRandomEntity:function(){var a=AI.knownWalkableEntities[Math.floor(Math.random()*AI.knownWalkableEntities.length)];return AI.decide(AI.WALK,null,a[0],a[1])},decideAttackEntity:function(a){return AI.decide(AI.ATTACK,null,a[0],a[1])},decideAttackRandomEntity:function(){var a=AI.knownAttackableEntities[Math.floor(Math.random()*AI.knownAttackableEntities.length)];return AI.decide(AI.ATTACK,null,
a[0],a[1])},decideWalkToRandomField:function(){var a=AI.knownWalkableFields[Math.floor(Math.random()*AI.knownWalkableFields.length)];return AI.decide(AI.WALK,null,a[0],a[1])},decideWait:function(a){return AI.decide(AI.WAIT,a,null,null)},makeDecision:function(a,c,b,d){AI.knownWalkableFields=Explorer.discoverWalkables(c);AI.knownWalkableEntities=Explorer.discoverWalkables(c).filter(function(b){b=[a.getEntityAtXY(b[0]-1,b[1]),a.getEntityAtXY(b[0]+1,b[1]),a.getEntityAtXY(b[0],b[1]-1),a.getEntityAtXY(b[0],
b[1]+1)];for(var d=0;4>d;++d)if(null!==b[d]&&b[d].stats.side!==c.stats.side&&0<b[d].stats.hpLeft)return!0;return!1});AI.knownAttackableEntities=Explorer.discoverAttackables(c).filter(function(b){b=a.getEntityAtXY(b[0],b[1]);return null!==b&&b.stats.side!==c.stats.side&&0<b.stats.hpLeft});var e=a.getEntities("side",c.stats.side===Entity.ALLIED?Entity.ENEMY:Entity.ALLIED),f=a.getAllEntities(),l=function(){if(!b){if(!(0<c.stats.attackRange)&&(c.stats.hpLeft>.5*c.stats.hpMax||.3>Math.random()))if(.3>
Math.random()){if(0<AI.knownWalkableFields.length)return AI.decideWalkToRandomField()}else if(0<AI.knownWalkableEntities.length)return AI.decideWalkToRandomEntity();if(0<AI.knownWalkableFields.length)return AI.decideWalkToRandomField()}var d=(a.map.gridWidth+1)*(a.map.gridHeight+1),f=Entity.direction.SOUTH;if(.8>Math.random())for(var h=0,l=e.length;h<l;++h){var q=Utils.getDistance2(c.gridX,c.gridY,e[h].gridX,e[h].gridY);q<d&&(d=q,f=Entity.getDirectionByAngle(Utils.getAngleDegrees(c.gridX,c.gridY,
e[h].gridX,e[h].gridY)))}else f=Entity.getRandomDirection();return AI.decideWait(f)};return function(){if(d)return l();if(0<c.stats.attackRange){for(var a=c.stats.attackRange*c.stats.attackRange,b=0,e=null,m=0,q=AI.knownAttackableEntities.length;m<q;++m){for(var p,g=a,u=AI.knownAttackableEntities[m][0],w=AI.knownAttackableEntities[m][1],r=p=0,x={},t=0,y=f.length;t<y;++t)Utils.getDistance2(u,w,f[t].gridX,f[t].gridY)<=g&&void 0===x[f[t].uid]&&(f[t].stats.side===c.stats.side?++r:++p,x[f[t].uid]=!0);
g=p-r;if(0===p||0>g||0===g&&.5>Math.random())g=0;p=g;p>b&&(b=p,e=AI.knownAttackableEntities[m])}return null!==e?AI.decideAttackEntity(e):l()}return 0<AI.knownAttackableEntities.length?AI.decideAttackRandomEntity():l()}()}},Splash=function(a){GameState.call(this,a);var c=0,b=!0;this.init=function(){};this.tick=function(d){c+=d;500<=c&&(b=!b,c=0);a.mouseKeyPressed(0)&&a.switchState("howto")};this.render=function(a){Art.splash.render(a,0,0);b&&Font.Gold.renderString(a,"CLICK TO START",120-Font.Gold.getWidth("CLICK TO START")/
2,100)}};Splash.prototype=Object.create(GameState.prototype);
var HowToPlay=function(a){GameState.call(this,a);this.init=function(){};this.tick=function(a){};this.render=function(c){Art.howto.render(c,0,0);Font.White.renderString(c,"HOW TO PLAY",4,5);Font.White.renderString(c,"Press Q to move",4,20);Font.White.renderString(c,"Press W to wait",4,32);Font.White.renderString(c,"Press E to attack",4,44);Font.White.renderString(c,"You can move and attack",4,56);Font.White.renderString(c,"once per round.",4,68);Font.Gold.renderString(c,"CLICK TO CONTINUE",4,144);
a.mouseKeyPressed(0)&&a.switchState("game")}};HowToPlay.prototype=Object.create(GameState.prototype);
var InGame=function(a){GameState.call(this,a);var c=new Aisenfield,b=new Board(c),d=new Display,e=new Stats(0),f=new Stats(1),l=0,k=0,n=45,h=45,m=0,q=0,p=!1;e.x=-136;e.y=120;f.x=240;f.y=120;var g=null,u=!1,w=!1,r=new Staging(Stage.SCROLL_TO_CURRENT),x=!1,t=1,y=null,A=!1,z=new InventoryDisplay,C=function(){g.stats.side!==Entity.ENEMY||A||(A=!0,a.scheduleTask(1E3,function(){var c=AI.makeDecision(b,g,u,w);console.log("AI",c);switch(c.decision){case AI.WALK:v(1);a.scheduleTask(750,function(){B(c.targetX,
c.targetY);a.scheduleTask(300,function(){E(c.targetX,c.targetY);A=!1})});break;case AI.ATTACK:v(0);a.scheduleTask(750,function(){B(c.targetX,c.targetY);a.scheduleTask(750,function(){F(c.targetX,c.targetY);A=!1})});break;case AI.WAIT:v(2),a.scheduleTask(300,function(){g.turn(c.direction);a.scheduleTask(300,function(){r.setCurrent(Stage.CYCLE_ENTITY);A=!1})})}}))},v=function(a,c){t=a;b.unBlink();2===a?b.unPoint():c||g.stats.side!==Entity.ALLIED||(a=b.toGridXY(n,h),B(a.x,a.y))},E=function(a,c){a=(new AStar(b,
Math.floor(g.gridX)+.5,Math.floor(g.gridY)+.5,Math.floor(a)+.5,Math.floor(c)+.5)).findPath();g.walkPath(a);r.setCurrent(Stage.SCROLL_TO_CURRENT);y=t},F=function(a,c){a=Utils.roundPt5(a);c=Utils.roundPt5(c);var d=Explorer.discoverEntitiesInRadius(a,c,g.stats.attackRange);if(0<d.length)for(r.setCurrent(Stage.SCROLL_TO_CURRENT),y=t,b.attackXY(g,a,c),g.attack(),a=0,c=d.length;a<c;++a)d[a].receiveAttack(g)},B=function(a,c){if(!b.map.isOutOfBounds(a,c)){2!==t&&b.pointAt(Math.floor(a),Math.floor(c));var d=
b.getEntityAtXY(Math.floor(a),Math.floor(c));d&&f.getEntity()===d||(f.setEntity(null),f.x=240,f.y=120);2!==t&&d&&f.getEntity()!==d&&b.getCurrentEntity()!==d&&(f.setEntity(d),f.moveTo(144,120));if(0===t&&Explorer.foundField(Utils.roundPt5(a),Utils.roundPt5(c),b.getAttackables()))for(a=Explorer.discoverEntitiesInRadius(Utils.roundPt5(a),Utils.roundPt5(c),g.stats.attackRange),c=0,d=a.length;c<d;++c)a[c].isBlinking=!0}};this.init=function(){for(var a=0;6>a;++a)3>a?b.spawnEntity(Soldier,!0):b.spawnEntity(Soldier,
!1);for(a=0;4>a;++a)2>a?b.spawnEntity(Mogry,!0):b.spawnEntity(Mogry,!1);g=b.getCurrentEntity();Explorer.board=b;e.setEntity(g);d.addComponent(e);d.addComponent(f);r.addTrigger([Stage.INTRO,Stage.SCROLL_TO_CURRENT,Stage.AWAIT_MOVE_1,Stage.WALK_TO_TARGET_1,Stage.DISPLAY_ATTACK_1,Stage.AWAIT_MOVE_2,Stage.WALK_TO_TARGET_2,Stage.DISPLAY_ATTACK_2,Stage.SET_WAITING_POSITION],function(){b.unBlink()});r.addTrigger([Stage.INTRO,Stage.SCROLL_TO_CURRENT,Stage.WALK_TO_TARGET_1,Stage.DISPLAY_ATTACK_1,Stage.WALK_TO_TARGET_2,
Stage.DISPLAY_ATTACK_2],function(){x=!0;e.x=-136;b.showWalkables=!1;b.showAttackables=!1});r.addTrigger([Stage.AWAIT_MOVE_1,Stage.AWAIT_MOVE_2,Stage.SET_WAITING_POSITION],function(){x=!1;e.moveTo(0,120)})};this.tick=function(c){PerformanceCounter.tick(c);z.setEntity(g);b.tick(c);d.tick(c);!x&&p?(Cursor.set("translate",a.screenNode),b.centerX=l+(m-n),b.centerY=k+(q-h)):2===t&&g.stats.side===Entity.ALLIED?Cursor.set("wait_"+g.getCurrentDirection(),a.screenNode):Cursor.set("default",a.screenNode);switch(r.getCurrent()){case Stage.CYCLE_ENTITY:v(1,
!0);w=u=!1;b.cycleNextEntity()?(g=b.getCurrentEntity(),e.setEntity(g),r.setCurrent(Stage.SCROLL_TO_CURRENT)):b.getEnemyCount()>b.getAllyCount()?a.switchState("go_defeat"):a.switchState("go_victory");break;case Stage.SCROLL_TO_CURRENT:f.setEntity(null);f.x=240;f.y=120;if(1<Utils.getDistance(b.centerX,b.centerY,g.screenX,g.screenY)){c=Utils.getAngle(g.screenX,g.screenY,b.centerX,b.centerY);var D=Utils.getDistance(b.centerX,b.centerY,g.screenX,g.screenY)/25+.5;b.centerX+=D*Math.cos(c);b.centerY+=D*Math.sin(c)}else b.centerX=
g.screenX,b.centerY=g.screenY,r.lastWas([null,Stage.CYCLE_ENTITY])?(r.setCurrent(Stage.AWAIT_MOVE_1),b.entityDiscover(g.uid)):r.lastWas([Stage.AWAIT_MOVE_1,Stage.AWAIT_MOVE_2])&&(1===y?(u=!0,r.setCurrent(r.lastWas(Stage.AWAIT_MOVE_1)?Stage.WALK_TO_TARGET_1:Stage.WALK_TO_TARGET_2)):0===y&&(w=!0,r.setCurrent(r.lastWas(Stage.AWAIT_MOVE_1)?Stage.DISPLAY_ATTACK_1:Stage.DISPLAY_ATTACK_2))),g.stats.side===Entity.ALLIED&&(c=b.toGridXY(n,h),B(c.x,c.y));break;case Stage.AWAIT_MOVE_1:case Stage.AWAIT_MOVE_2:C();
1===t?(b.showWalkables=!0,b.showAttackables=!1):0===t?(b.showWalkables=!1,b.showAttackables=!0):2===t&&(b.showWalkables=!1,b.showAttackables=!1);break;case Stage.DISPLAY_ATTACK_1:if(g.isDead()){r.setCurrent(Stage.CYCLE_ENTITY);break}g.getState()===Entity.state.IDLE&&(r.setCurrent(Stage.AWAIT_MOVE_2),v(1));break;case Stage.DISPLAY_ATTACK_2:if(g.isDead()){r.setCurrent(Stage.CYCLE_ENTITY);break}g.getState()===Entity.state.IDLE&&(v(2),r.setCurrent(Stage.SET_WAITING_POSITION));break;case Stage.WALK_TO_TARGET_1:b.centerOnEntity(g);
g.arrived&&(r.setCurrent(Stage.AWAIT_MOVE_2),b.entityDiscover(g.uid),b.unPoint(),v(0));break;case Stage.WALK_TO_TARGET_2:b.centerOnEntity(g);g.arrived&&(v(2),r.setCurrent(Stage.SET_WAITING_POSITION));break;case Stage.SET_WAITING_POSITION:b.unPoint(),C()}};this.render=function(a){b.render(a);d.render(a);Art.mode[t].render(a,211,5);z.render(a);PerformanceCounter.render(a)};this.onKeyDown=function(a){116===a.keyCode&&window.location.reload(!0);if(g.stats.side===Entity.ALLIED&&r.currentIs([Stage.AWAIT_MOVE_1,
Stage.AWAIT_MOVE_2,Stage.SET_WAITING_POSITION]))switch(a.key.toUpperCase()){case "Q":u||v(1);break;case "E":w||v(0);break;case "W":v(2);break;case "F":z.isVisible()?z.hide():z.show()}};this.onMouseClick=function(a){0===t&&w||1===t&&u||z.isVisible()||g.stats.side!==Entity.ALLIED||(a=b.toGridXY(a.offsetX,a.offsetY),1===t?r.currentIs([Stage.AWAIT_MOVE_1,Stage.AWAIT_MOVE_2])&&b.isWalkable(a.x,a.y)&&E(a.x,a.y):0===t&&g.canAttack()?b.isAttackable(a.x,a.y)&&F(a.x,a.y):2===t&&r.setCurrent(Stage.CYCLE_ENTITY))};
this.onMouseDown=function(a){g.stats.side===Entity.ALLIED&&1===a.button&&(p=!0,m=a.offsetX,q=a.offsetY,l=b.centerX,k=b.centerY)};this.onMouseUp=function(a){p=!1};this.onMouseMove=function(a){n=a.offsetX;h=a.offsetY;b.unBlink();if(g.stats.side===Entity.ALLIED){var c=b.toGridXY(a.offsetX,a.offsetY);r.currentIs([Stage.AWAIT_MOVE_1,Stage.AWAIT_MOVE_2])&&B(c.x,c.y);(r.currentIs([Stage.SET_WAITING_POSITION])||2===t)&&g.turnToDirectionByAngle(Utils.getAngleDegrees(g.gridX,g.gridY,c.x,c.y));n=a.offsetX;h=
a.offsetY}}};InGame.prototype=Object.create(GameState.prototype);var GameOverVictory=function(a){GameState.call(this,a);this.init=function(){};this.tick=function(a){};this.render=function(a){Art.howto.render(a,0,0);Font.Gold.renderString(a,"VICTORY!",4,5)}};GameOverVictory.prototype=Object.create(GameState.prototype);
var GameOverDefeat=function(a){GameState.call(this,a);this.init=function(){};this.tick=function(a){};this.render=function(a){Art.howto.render(a,0,0);Font.Gold.renderString(a,"DEFEAT!",4,5)}};GameOverDefeat.prototype=Object.create(GameState.prototype);
var Tactix=function(a,c){var b=new StateBasedGame(a,c);b.addState("splash",new Splash(b));b.addState("howto",new HowToPlay(b));b.addState("game",new InGame(b));b.addState("go_victory",new GameOverVictory(b));b.addState("go_defeat",new GameOverDefeat(b));Cursor.add("default","assets/cursor/pointer.png");Cursor.add("translate","assets/cursor/translate.png");Cursor.add("wait_north","assets/cursor/wait_north.png");Cursor.add("wait_west","assets/cursor/wait_west.png");Cursor.add("wait_south","assets/cursor/wait_south.png");
Cursor.add("wait_east","assets/cursor/wait_east.png");Cursor.set("default",b.screenNode);b.init();a=function(){b.setScale(Math.min(window.innerWidth/b.settings.screenWidth,window.innerHeight/b.settings.screenHeight))};window.addEventListener("resize",a);a();this.run=function(){b.start()}};(function(){var a=document.getElementById("screen");(new Tactix(a,{scale:3})).run()})();
